<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Directeur D√©partemental - Validation</title>
    <style>
        /* --- Styles CSS : Variables et Mise en page de base --- */
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #00796b;
            --accent-color: #fbc02d;
            --background-color: #f5f7fa;
            --text-color: #333;
            --border-color: #e0e0e0;
            --white-color: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 8px;
            --sidebar-width: 260px;
        }
        body { font-family:'Segoe UI', Tahoma, Geneva, Verdana,sans-serif; margin:0; background-color:var(--background-color); color:var(--text-color); display:flex; height:100vh; overflow:hidden; }
        .sidebar { width:var(--sidebar-width); background-color:var(--primary-color); color:var(--white-color); display:flex; flex-direction:column; box-shadow:2px 0 5px rgba(0,0,0,0.1); transition: transform 0.3s ease-in-out; z-index:1000; }
        .sidebar-header { padding:20px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.1); }
        .sidebar-header h1 { margin:0; font-size:1.5rem; letter-spacing:1px; }
        .sidebar-nav ul { list-style:none; padding:20px 0; margin:0; }
        .sidebar-nav a { 
            display:flex; 
            align-items:center; 
            padding:15px 25px; 
            color:var(--white-color); 
            text-decoration:none; 
            font-weight:500; 
            transition: background-color 0.3s, padding-left 0.3s; 
            border-left:4px solid transparent; 
        }
        .sidebar-nav a svg { margin-right:15px; width:20px; height:20px; flex-shrink:0; }
        .sidebar-nav a:hover { background-color: rgba(255,255,255,0.05); }
        .sidebar-nav a.active { 
            background-color: rgba(0,0,0,0.2); 
            border-left:4px solid var(--accent-color); 
            font-weight:bold; 
        }
        .sidebar-footer { margin-top:auto; padding:20px; text-align:center; border-top:1px solid rgba(255,255,255,0.1); }
        .sidebar-footer #user-name { font-weight:bold; display:block; }
        .sidebar-footer #user-department { font-size:0.9em; opacity:0.8; display:block; }
        .main-content { flex:1; display:flex; flex-direction:column; height:100vh; overflow-x:hidden; }
        .main-header { display:flex; align-items:center; background-color:var(--white-color); padding:15px 30px; border-bottom:1px solid var(--border-color); box-shadow:var(--shadow); z-index:10; }
        .menu-toggle { display:none; background:none; border:none; cursor:pointer; margin-right:20px; }
        .menu-toggle svg { width:28px; height:28px; }
        .main-header h2 { margin:0; font-size:1.8rem; color:var(--primary-color); }
        .content-area { flex:1; padding:30px; overflow-y:auto; }
        .content-section { display:none; background-color:var(--white-color); padding:30px; border-radius:var(--border-radius); box-shadow:var(--shadow); }
        .content-section.active { display:block; }
        .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:25px; }
        .form-section-title { grid-column:1/-1; font-size:1.3rem; font-weight:600; color:var(--primary-color); margin-top:20px; margin-bottom:10px; padding-bottom:10px; border-bottom:2px solid var(--secondary-color); }
        .form-group { display:flex; flex-direction:column; }
        .form-group label { margin-bottom:8px; font-weight:600; font-size:0.9rem; }
        .form-group input, .form-group select { padding:12px; border:1px solid var(--border-color); border-radius:var(--border-radius); font-size:1rem; transition:border-color 0.3s, box-shadow 0.3s; }
        .form-group input:focus, .form-group select:focus { outline:none; border-color:var(--primary-color); box-shadow:0 0 0 3px rgba(13,71,161,0.2); }
        .form-group input[readonly] { background-color: var(--background-color); color:#777; }
        .form-actions { grid-column:1/-1; display:flex; justify-content:flex-end; margin-top:30px; }
        .btn { padding:10px 18px; border:none; border-radius:var(--border-radius); font-size:0.9rem; font-weight:bold; cursor:pointer; text-transform:uppercase; letter-spacing:0.5px; transition:all 0.3s; margin-left:10px; }
        .btn-primary { background-color:var(--secondary-color); color:var(--white-color); box-shadow:0 2px 4px rgba(0,121,107,0.3); }
        .btn-primary:hover { background-color:#004d40; transform:translateY(-1px); box-shadow:0 4px 8px rgba(0,121,107,0.4); }
        .btn-danger { background-color:#d32f2f; color:var(--white-color); }
        .btn-danger:hover { background-color:#b71c1c; transform:translateY(-1px); }
        /* Style pour la barre de filtrage */
        .search-bar { display:flex; gap:15px; margin-bottom:25px; align-items:center; }
        .search-bar input { flex-grow:1; padding:12px; font-size:1rem; border:1px solid var(--border-color); border-radius:var(--border-radius); }
        .search-bar select { padding:12px; border:1px solid var(--border-color); border-radius:var(--border-radius); min-width: 200px; }
        .table-container { overflow-x:auto; }
        .data-table { width:100%; border-collapse:collapse; margin-top:20px; }
        .data-table th, .data-table td { padding:15px; text-align:left; border-bottom:1px solid var(--border-color); white-space:nowrap; }
        .data-table th { background-color:var(--background-color); font-weight:600; cursor:pointer; }
        
        /* üéØ NOUVEAU CSS POUR LES STATISTIQUES */
        .stat-card {
            background-color: var(--white-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            border-left: 5px solid var(--secondary-color);
        }
        .stat-card:nth-child(2) {
            border-left: 5px solid var(--accent-color); /* Couleur pour l'attente */
        }
        .stat-card:nth-child(3) {
            border-left: 5px solid var(--primary-color); /* Couleur pour le valid√© */
        }
        .stat-label {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: #777;
            font-weight: 600;
        }
        .stat-value {
            margin: 0;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Media Queries */
        @media (max-width:1024px) { 
            :root { --sidebar-width:220px; } 
            .content-area { padding:20px; } 
            .main-header h2 { font-size:1.5rem; } 
        }
        @media (max-width:768px) { 
            .sidebar { position:absolute; transform:translateX(-100%); } 
            .sidebar.open { transform:translateX(0); } 
            .menu-toggle { display:block; } 
            .main-header { padding:15px; } 
            .content-area { padding:15px; } 
            .form-grid { grid-template-columns:1fr; } 
            .search-bar { flex-direction: column; align-items: stretch; }
            .search-bar select { min-width: 100%; }
        }
    </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <div class="sidebar-header"><h1>Validation DD</h1></div>
    <nav class="sidebar-nav">
        <ul>
            <li><a href="#" id="nav-list" class="nav-link active" data-section="list-section">Gestion des Dossiers</a></li>
            
            <li><a href="#" id="nav-stats" class="nav-link" data-section="stats-section">Statistiques D√©partementales</a></li>
            
            <li><a href="#" id="nav-logout" class="nav-link">D√©connexion</a></li>
        </ul>
    </nav>
    <div class="sidebar-footer">
        <span id="user-name">Chargement...</span>
        <span id="user-department">Chargement...</span>
    </div>
</aside>

<div class="main-content">
    <header class="main-header">
        <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
        <h2 id="page-title">Dossiers √† Valider</h2>
    </header>

    <main class="content-area">
        <section id="form-section" class="content-section" style="display:none;"></section>

        <section id="list-section" class="content-section active">
            <div class="search-bar">
                <input type="text" id="search-dossier" placeholder="Rechercher par r√©f√©rence, immatriculation...">
                
                <select id="status-filter">
                    <option value="en_attente_validation_officielle">Dossiers √† Valider (En Attente)</option>
                    <option value="valid√©">Historique: Dossiers Valid√©s</option>
                    <option value="rejet√©">Historique: Dossiers Rejet√©s</option>
                </select>
            </div>
            <div id="dossier-list"></div>
        </section>

        <section id="stats-section" class="content-section">
            <h3 class="form-section-title">Synth√®se des Enregistrements dans votre D√©partement</h3>
            <div class="form-grid">
                
                <div class="stat-card">
                    <p class="stat-label">Total Dossiers Enregistr√©s</p>
                    <p class="stat-value" id="total-motos">...</p>
                </div>

                <div class="stat-card">
                    <p class="stat-label">En Attente de Validation DD</p>
                    <p class="stat-value" id="motos-attente">...</p>
                </div>
                
                <div class="stat-card">
                    <p class="stat-label">Certificats Officiels (Valid√©s)</p>
                    <p class="stat-value" id="motos-validees">...</p>
                </div>
                
            </div>
        </section>
        </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ----------------------------------------------------------------------
    // üîπ VARIABLES GLOBALES
    // ----------------------------------------------------------------------
    const contentSections = document.querySelectorAll('.content-section');
    const pageTitle = document.getElementById('page-title');
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const searchInput = document.getElementById('search-dossier');
    const statusFilter = document.getElementById('status-filter'); 
    const dossierListContainer = document.getElementById('dossier-list');
    
    // üéØ Adresses API
    const API_BASE_URL = 'https://moto-api-cika.onrender.com/api/dossier_admin';
    const STATS_API_URL = 'https://moto-api-cika.onrender.com/api/statistiques/statistiques'; // üí° NOUVELLE URL POUR LES STATS
    
    const storedUser = JSON.parse(localStorage.getItem('user'));
    
    // ----------------------------------------------------------------------
    // üîπ S√âCURIT√â & V√âRIFICATION DE R√îLE
    // ----------------------------------------------------------------------
    const token = localStorage.getItem('token');
    const profil = (localStorage.getItem('utilisateur_profil') || '').toLowerCase().replace(/\s+/g, '_');

    if (!token || profil !== 'directeur_departemental') {
        alert("Acc√®s non autoris√©. Veuillez vous connecter comme Directeur D√©partemental.");
        window.location.href = 'login.html';
        return;
    }
// ----------------------------------------------------------------------
// üîπ FONCTION UTILITAIRE : D√©codage du JWT (Conserv√©e)
// ----------------------------------------------------------------------
function decodeJwt(token) {
¬† ¬† if (!token) return null;
¬† ¬† try {
¬† ¬† ¬† ¬† const base64Url = token.split('.')[1];
¬† ¬† ¬† ¬† const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
¬† ¬† ¬† ¬† const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
¬† ¬† ¬† ¬† ¬† ¬† return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
¬† ¬† ¬† ¬† }).join(''));
¬† ¬† ¬† ¬† return JSON.parse(jsonPayload);
¬† ¬† } catch (e) {
¬† ¬† ¬† ¬† console.error("Erreur de d√©codage du token JWT:", e);
¬† ¬† ¬† ¬† return null;
¬† ¬† }
}

// ----------------------------------------------------------------------
// üîπ GESTION DE LA TRA√áABILIT√â (FOOTER) - ADAPT√â AU NOUVEAU STOCKAGE
// ----------------------------------------------------------------------
function updateTraceability() {
¬† ¬† // 1. R√©cup√©ration des donn√©es brutes
¬† ¬† const token = localStorage.getItem('token');
¬† ¬† 
¬† ¬† // === ADAPTATION ICI : Utilisation des cl√©s individuelles ===
¬† ¬† let userName = localStorage.getItem('utilisateur_nom') || 'Directeur';
¬† ¬† let departementNom = localStorage.getItem('utilisateur_departement_nom') || 'D√©partement Inconnu';
¬† ¬† 
¬† ¬† // üí° Fallback pour le d√©partement au cas o√π le nom n'est pas stock√©
¬† ¬† if (departementNom === 'N/A' || departementNom === 'D√©partement Inconnu') {
¬† ¬† ¬† ¬† const deptId = localStorage.getItem('utilisateur_departement_id');
¬† ¬† ¬† ¬† if (deptId) {
¬† ¬† ¬† ¬† ¬† ¬† departementNom = `ID ${deptId} (Nom en attente)`;
¬† ¬† ¬† ¬† }
¬† ¬† }
¬† ¬† // ========================================================

¬† ¬† // 2. Priorit√© B (Fallback / Correction) : Informations du Token JWT
¬† ¬† // On utilise le token pour s'assurer que l'info n'est pas obsol√®te.
¬† ¬† const payload = decodeJwt(token);
¬† ¬† if (payload) {
¬† ¬† ¬† ¬† // Si le nom dans le token est disponible et diff√©rent, on peut l'utiliser
¬† ¬† ¬† ¬† // userName = payload.nom || userName; // Choix : garder le localStorage ou le token

¬† ¬† ¬† ¬† // Tentative de r√©cup√©ration du d√©partement depuis le token
¬† ¬† ¬† ¬† const tokenDept = payload.departement_nom || payload.departement;
¬† ¬† ¬† ¬† if (tokenDept && tokenDept !== departementNom) {
¬† ¬† ¬† ¬† ¬† ¬† departementNom = tokenDept;
¬† ¬† ¬† ¬† }
¬† ¬† }

¬† ¬† // 3. Injection dans le footer
¬† ¬† const userNameEl = document.getElementById('user-name');
¬† ¬† const userDeptEl = document.getElementById('user-department');
¬† ¬† ¬† ¬† 
¬† ¬† // S√©curit√© contre les valeurs null
¬† ¬† const displayedName = userName || 'Directeur';
¬† ¬† const displayedDept = departementNom || 'D√©partement Inconnu';

¬† ¬† if (userNameEl) userNameEl.textContent = displayedName;
¬† ¬† if (userDeptEl) userDeptEl.textContent = `Directeur - ${displayedDept}`;

¬† ¬† // 4. Mise √† jour du titre de la page
¬† ¬† document.title = `DD - ${displayedDept} - Validation`;
}

// Appel de la fonction mis √† jour
updateTraceability();
    // ----------------------------------------------------------------------
    // üîπ GESTION DES SECTIONS (Navigation)
    // ----------------------------------------------------------------------
    function showSection(sectionId) {
        contentSections.forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(sectionId).classList.add('active');
        
        // Mettre √† jour le titre de la page
        const navLink = document.querySelector(`[data-section="${sectionId}"]`);
        if (navLink) {
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            navLink.classList.add('active');
            pageTitle.textContent = navLink.textContent;
        }

        // Si on est sur la section stats, charger les donn√©es
        if (sectionId === 'stats-section') {
            loadStats();
        } else {
            // Sinon, recharger la liste si on retourne √† la gestion des dossiers
            loadDossiersAdmin(searchInput.value);
        }
    }

    document.getElementById('nav-list').addEventListener('click', (e) => {
        e.preventDefault();
        showSection('list-section');
    });

    document.getElementById('nav-stats').addEventListener('click', (e) => {
        e.preventDefault();
        showSection('stats-section');
    });

    // ----------------------------------------------------------------------
    // üîπ CHARGEMENT DES STATISTIQUES
    // ----------------------------------------------------------------------
    async function loadStats() {
        // Affichage de l'√©tat de chargement
        document.getElementById('total-motos').textContent = '...';
        document.getElementById('motos-attente').textContent = '...';
        document.getElementById('motos-validees').textContent = '...';

        try {
            // üí° URL CORRIG√âE : Utilisation de l'endpoint d√©di√© aux statistiques
            const url = STATS_API_URL; 
            
            const response = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
            
            if (!response.ok) {
                 const errorDetails = await response.json().catch(() => ({}));
                 // Afficher le message d'erreur du backend (si disponible) ou le statut
                 throw new Error(errorDetails.message || `√âchec de la r√©cup√©ration des statistiques. Statut: ${response.status}`);
            }

            const stats = await response.json(); 
            
            // Mise √† jour des cartes (doit correspondre aux cl√©s retourn√©es par le contr√¥leur)
            document.getElementById('total-motos').textContent = stats.total_enregistrements || 0;
            document.getElementById('motos-attente').textContent = stats.en_attente_validation_officielle || 0;
            document.getElementById('motos-validees').textContent = stats.valid√© || 0;

        } catch (err) {
            console.error("Erreur de chargement des statistiques:", err);
            document.getElementById('total-motos').textContent = 'Erreur';
            document.getElementById('motos-attente').textContent = 'Erreur';
            document.getElementById('motos-validees').textContent = 'Erreur';
        }
    }
    
    // ----------------------------------------------------------------------
// üîπ TRAITER UN DOSSIER (VALIDATION OFFICIELLE / REJET)
// ----------------------------------------------------------------------
async function traiterDossier(dossierId, nouveauStatut, referenceDossier = null, motoId = null) {
    if (!dossierId) {
        alert("Erreur: ID du dossier manquant.");
        return;
    }

    let bodyContent = { statut: nouveauStatut };
    let endpoint = `${API_BASE_URL}/${dossierId}`; // Endpoint par d√©faut pour PUT (rejet/m√†j)
    let method = 'PUT';

    // üõë 1. CAS CRITIQUE : VALIDATION OFFICIELLE
    if (nouveauStatut === 'valid√©') {
        if (!motoId || !referenceDossier) {
            alert("Erreur: Les informations du dossier et de la moto sont manquantes pour la validation officielle.");
            return;
        }

        method = 'POST';
        endpoint = 'https://moto-api-cika.onrender.com/api/dossier_admin/valider_officiel'; 

        bodyContent = { 
            id: dossierId,           // üîπ ID obligatoire pour le backend
            reference_dossier: referenceDossier,
            moto_id: motoId
        };
    }

    // 2. CAS DE REJET
    if (nouveauStatut === 'rejet√©') {
        const raison = prompt("Veuillez indiquer la raison du REJET :");
        if (!raison || raison.trim() === "") {
            alert("Raison du rejet obligatoire. Annulation de l'action.");
            return;
        }
        bodyContent.raison_rejet = raison;
    }

    try {
        const res = await fetch(endpoint, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(bodyContent)
        });

        const resData = await res.json().catch(() => ({}));

        if (!res.ok) {
            console.error(`Erreur: Statut ${res.status}`, resData);
            throw new Error(resData.message || `Erreur API: Statut ${res.status}`);
        }

        alert(`‚úÖ Dossier ${referenceDossier || dossierId} a √©t√© ${nouveauStatut} avec succ√®s.`);

        // üöÄ Redirection vers la Carte Grise OFFICIELLE
        if (nouveauStatut === 'valid√©') {
            window.location.href = `carte_grise_PROVISOIRE_FINI1.html?ref=${referenceDossier}`;
            return; 
        }

        // üîπ Recharger la liste des dossiers
        loadDossiersAdmin(searchInput.value); 

    } catch (error) {
        console.error(`‚ùå √âchec de la mise √† jour :`, error);
        alert(`√âchec de la mise √† jour : ${error.message}`);
    }
}

   async function loadDossiersAdmin(query = '') {
    dossierListContainer.innerHTML = "<p>Chargement des dossiers...</p>";
    const currentStatus = statusFilter.value;
    pageTitle.textContent = statusFilter.options[statusFilter.selectedIndex].text;

    try {
        let statutsAAfficher = [currentStatus];

        // üîπ Ajout du statut "envoy√©" pour les directeurs d√©partementaux
        if (profil === 'directeur_departemental' && currentStatus === 'en_attente_validation_officielle') {
            statutsAAfficher.push('envoy√©');
        }

        let dossiers = [];
        for (const statut of statutsAAfficher) {
            let url = `${API_BASE_URL}?statut=${encodeURIComponent(statut)}`;
            if (query) url += `&search=${encodeURIComponent(query)}`;
            
            const res = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
            if (res.ok) {
                const data = await res.json();
                dossiers = dossiers.concat(data);
            }
        }

        if (!dossiers.length) {
            dossierListContainer.innerHTML = `<p>Aucun dossier trouv√© pour ce statut dans votre d√©partement.</p>`;
            return;
        }

        // üîπ G√©n√©ration du tableau HTML
        let html=`<div class="table-container"><table class="data-table"><thead><tr>
            <th>R√©f√©rence</th>
            <th>Immat. Provisoire</th>
            <th>Moto (Ch√¢ssis)</th>
            <th>Saisi par</th>
            <th>Date Saisie</th>
            <th>Actions</th>
            </tr></thead><tbody>`;

        dossiers.forEach(dossier => {
            const moto = dossier.motos || {};
            const dateSaisie = new Date(dossier.date_creation).toLocaleDateString('fr-FR');

            html+=`<tr>
                <td>${dossier.reference_dossier}</td>
                <td>${dossier.immatriculation_prov || 'N/A'}</td>
                <td>${moto.marque || 'N/A'} ${moto.modele || ''} (${moto.numero_chassis || 'N/A'})</td>
                <td>${dossier.agent ? (dossier.agent.prenom || '') + ' ' + (dossier.agent.nom || '') : (dossier.acteur_type || 'N/A')}</td>
                <td>${dateSaisie}</td>
                <td>`;

            if (currentStatus === 'en_attente_validation_officielle') {
                html += `<button class="btn btn-primary btn-valider" 
                            data-id="${dossier.id}" 
                            data-ref="${dossier.reference_dossier}"
                            data-moto-id="${moto.id}"
                            >Valider</button>
                         <button class="btn btn-danger btn-rejeter" data-id="${dossier.id}">Rejeter</button>`;
            } else {
                html += `<span style="font-weight:bold;">${dossier.statut.toUpperCase()}</span>`; 
                if (dossier.raison_rejet) html += ` <small>(Raison: ${dossier.raison_rejet})</small>`;
            }

            html += `</td></tr>`;
        });

        html+=`</tbody></table></div>`;
        dossierListContainer.innerHTML = html;

        // üîπ Event Listeners pour Valider / Rejeter
        if (currentStatus === 'en_attente_validation_officielle') {
            document.querySelectorAll('.btn-valider').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.id;
                    const ref = btn.dataset.ref;
                    const motoId = btn.dataset.motoId;
                    if (!confirm(`Voulez-vous VALIDER officiellement le dossier ${ref} ?`)) return;
                    await traiterDossier(id, 'valid√©', ref, motoId);
                });
            });

            document.querySelectorAll('.btn-rejeter').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    traiterDossier(id, 'rejet√©');
                });
            });
        }

    } catch (err) {
        console.error("Erreur de chargement des dossiers admin:", err);
        dossierListContainer.innerHTML = `<p style='color:red;'>Erreur de chargement des dossiers: ${err.message}</p>`; 
    }
}



    // ----------------------------------------------------------------------
    // üîπ INITIALISATION ET √âCOUTEURS DES FILTRES
    // ----------------------------------------------------------------------
    searchInput.addEventListener('input', () => loadDossiersAdmin(searchInput.value));
    statusFilter.addEventListener('change', () => loadDossiersAdmin(searchInput.value)); 
    
    // Charge la section par d√©faut au d√©marrage
    showSection('list-section'); 

});
</script>

</body>
</html>