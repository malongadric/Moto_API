<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation Dossier - R√©f√©rence Sp√©cifique</title>
    <style>
        :root {
            --primary-color: #0d47a1; 
            --secondary-color: #00796b; 
            --danger-color: #d32f2f; 
            --background-color: #f5f7fa;
            --text-color: #333;
            --border-color: #e0e0e0;
            --white-color: #ffffff;
            --shadow: 0 8px 30px rgba(0,0,0,0.4);
            --border-radius: 8px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto;
            background-image: url('/* LIEN VERS VOTRE IMAGE DE FOND */'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .main-content {
            width: 90%;
            max-width: 700px;
            margin: 30px auto;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(5px);
        }

        .main-header {
            background-color: var(--primary-color);
            color: var(--white-color);
            padding: 15px 20px;
            text-align: center;
        }
        
        .main-header h2 { margin: 0; font-size: 1.6rem; text-transform: uppercase; letter-spacing: 1px; }

        .content-area { padding: 20px; }

        .form-section-title {
            font-size: 1.2rem; font-weight: 600;
            color: var(--primary-color); margin-top: 0; margin-bottom: 8px;
            padding-bottom: 8px; border-bottom: 2px solid var(--secondary-color);
        }

        .confirmation-summary {
            background-color: var(--background-color);
            padding: 20px; border-radius: var(--border-radius);
            margin-bottom: 20px; border: 1px solid var(--border-color);
        }
        .confirmation-summary h4 { color: var(--primary-color); margin-top: 20px; margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px dashed var(--border-color); font-size: 1.1rem; }
        .confirmation-summary h4:first-child { margin-top: 0; }
        .confirmation-summary p { display: flex; justify-content: space-between; margin: 6px 0; font-size: 0.95rem; }
        .confirmation-summary span.label { font-weight: 500; color: #555; margin-right: 15px; }
        .confirmation-summary strong.value { font-weight: 700; color: var(--text-color); text-align: right; }

        .info-message { padding: 12px; border-left: 4px solid var(--primary-color); border-radius: var(--border-radius); margin-bottom: 15px; }

        .form-actions { display: flex; justify-content: flex-end; margin-top: 20px; gap: 10px; }
        .btn { padding: 8px 20px; border: none; border-radius: 6px; font-size: 0.9rem; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s; }
        .btn-secondary { background-color: var(--border-color); color: var(--text-color); }
        .btn-primary { background-color: var(--secondary-color); color: var(--white-color); }
        .btn-danger { background-color: var(--danger-color); color: var(--white-color); }
        .btn-secondary:hover, .btn-primary:hover, .btn-danger:hover { transform: translateY(-1px); }

        @media (max-width: 768px) {
            .main-content { margin: 15px auto; width: 95%; max-width: 100%; }
            .content-area { padding: 15px; }
            .form-actions { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <header class="main-header">
            <h2 id="page-title">Validation du Dossier</h2>
        </header>

        <main class="content-area">
             <section id="details-section" class="content-section active">
                <h3 class="form-section-title">Validation du Dossier: <span id="detail-ref-title"></span></h3>

                <div class="info-message">
                    <p style="margin: 0; font-size: 0.9rem;"><strong>V√©rification :</strong> Veuillez inspecter toutes les informations et pi√®ces justificatives avant de valider. Statut actuel: **"En Attente de Validation Sup√©rieure"**.</p>
                </div>
                
                <div class="confirmation-summary" id="detail-summary"></div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="btn-retour-liste">Retour √† la Liste</button>
                    <button type="button" class="btn btn-danger" id="btn-rejeter-dossier">Rejeter le Dossier</button>
                    <button type="button" class="btn btn-primary" id="btn-valider-dossier">Valider le Dossier</button>
                </div>
            </section>
        </main>
    </div>

<script>

let dossier = null; 
let moto = null;
let token = null; 

document.addEventListener('DOMContentLoaded', async function() {
    const detailSummary = document.getElementById('detail-summary');
    const detailRefTitle = document.getElementById('detail-ref-title');
    const pageTitle = document.getElementById('page-title');

    // üîπ R√©cup√©ration de la r√©f√©rence et du token
    const urlParams = new URLSearchParams(window.location.search);
    let referenceDossierRaw = urlParams.get('ref') || localStorage.getItem('selected_reference_dossier');
    token = localStorage.getItem('token'); 

    if (!referenceDossierRaw) {
        detailSummary.innerHTML = '<p>‚ùå Dossier non trouv√©. Aucune r√©f√©rence fournie.</p>';
        detailRefTitle.textContent = "Erreur";
        return;
    }
    if (!token) {
        detailSummary.innerHTML = '<p>‚ùå Vous devez √™tre connect√© pour voir ce dossier.</p>';
        detailRefTitle.textContent = "Erreur";
        return;
    }

    referenceDossierRaw = referenceDossierRaw.trim();
    localStorage.setItem('selected_reference_dossier', referenceDossierRaw);
    
    // --- D√©but de la r√©cup√©ration optimis√©e ---

    try {
        // üîπ 1Ô∏è‚É£ Appel unique (l'API retourne toutes les jointures)
        let resDossier = await fetch(`https://moto-api-cika.onrender.com/api/dossiers/by-reference?reference_dossier=${encodeURIComponent(referenceDossierRaw)}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        // üîπ 2Ô∏è‚É£ Si 404, retenter sans suffixe
        if (!resDossier.ok && referenceDossierRaw.includes(':')) {
            const referenceSansSuffixe = referenceDossierRaw.split(':')[0];
            resDossier = await fetch(`https://moto-api-cika.onrender.com/api/dossiers/by-reference?reference_dossier=${encodeURIComponent(referenceSansSuffixe)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
        }

        if (!resDossier.ok) {
            const errorBody = await resDossier.json();
            throw new Error(errorBody.message || `Erreur ${resDossier.status}: Aucun dossier trouv√© pour cette r√©f√©rence`);
        }

        const dossierData = await resDossier.json();
        
        // üèÜ R√©cup√©ration des donn√©es du dossier complet
        dossier = dossierData.dossier; 

        if (!dossier) throw new Error('Aucun dossier trouv√© apr√®s d√©codage JSON.');

        
        // ------------------------------------------------------------------
        // üèÖ MISE √Ä JOUR CRITIQUE : Extraction et Affichage des Donn√©es Jointes
        // ------------------------------------------------------------------
        
        // V√©rifie si la relation est un tableau ou un objet et l'extrait
        const proprietaire = dossier.proprietaire?.[0] || dossier.proprietaire; 
        const mandataire = dossier.mandataire?.[0] || dossier.mandataire;
        moto = dossier.moto?.[0] || dossier.moto; // moto est la variable globale
        const agentData = dossier.agent?.[0] || dossier.agent; // Agent data

        // Calcul du nom de l'agent pour l'affichage (r√©pond √† votre demande)
        const agentNom = agentData ? 
            `${agentData.prenom || ''} ${agentData.nom || ''}`.trim() : 
            `ID: ${dossier.agent_id || '‚Äî'}`;
        
        // üîπ Stocker moto_id et dossier_id pour usage futur
        if (moto && moto.id) {
            localStorage.setItem('moto_id', moto.id);
            localStorage.setItem('dossier_id', dossier.dossier_id);
        }
    
        // üîπ 3Ô∏è‚É£ Affichage des informations
        detailRefTitle.textContent = dossier.reference_dossier;
        pageTitle.textContent = `Validation du Dossier: ${dossier.reference_dossier}`;

        let htmlContent = `
            <h4>A. Informations Propri√©taire / D√©clarant</h4>
            <p><span class="label">Type de d√©clarant:</span> <strong>${dossier.acteur_type}</strong></p>
            ${proprietaire ? `
                <p><span class="label">Nom Propri√©taire:</span> <strong>${proprietaire.nom} ${proprietaire.prenom}</strong></p>
                <p><span class="label">N¬∞ Pi√®ce Propri√©taire:</span> <strong>${proprietaire.cni || '‚Äî'}</strong></p>
                <p><span class="label">T√©l√©phone Propri√©taire:</span> <strong>${proprietaire.telephone || '‚Äî'}</strong></p>
            ` : ''}
            ${mandataire ? `
                <hr style="border-style: dashed; border-color: #ddd;">
                <p><span class="label">Nom Mandataire:</span> <strong>${mandataire.nom} ${mandataire.prenom}</strong></p>
                <p><span class="label">N¬∞ Pi√®ce Mandataire:</span> <strong>${mandataire.cni || '‚Äî'}</strong></p>
                <p><span class="label">T√©l√©phone Mandataire:</span> <strong>${mandataire.telephone || '‚Äî'}</strong></p>
            ` : ''}
            <h4 style="margin-top: 20px;">B. Informations de la Moto</h4>
            
            ${moto ? `
                <p><span class="label">Marque / Mod√®le:</span> <strong>${moto.marque || '‚Äî'} ${moto.modele || ''}</strong></p>
                <p><span class="label">N¬∞ S√©rie (Ch√¢ssis):</span> <strong>${moto.numero_chassis || '‚Äî'}</strong></p>
                <p><span class="label">Immatriculation:</span> <strong>${moto.numero_immatriculation || 'En attente'}</strong></p>
                <p><span class="label">Couleur:</span> <strong>${moto.couleur || '‚Äî'}</strong></p>
            ` : 'Aucune moto trouv√©e.'}


            <h4 style="margin-top: 20px;">C. Tra√ßabilit√© du Dossier</h4>
            <p><span class="label">R√©f√©rence du Dossier:</span> <strong>${dossier.reference_dossier}</strong></p>
            
            <p><span class="label">Agent Traitant:</span> <strong>${agentNom}</strong></p> <p><span class="label">Date de Cr√©ation:</span> <strong>${new Date(dossier.date_soumission).toLocaleString('fr-FR')}</strong></p>
            <p><span class="label">Statut actuel:</span> <strong>${dossier.statut}</strong></p>
        `;
        detailSummary.innerHTML = htmlContent;

    } catch (err) {
        console.error("Erreur critique de chargement:", err);
        detailSummary.innerHTML = `<p>‚ùå Impossible de r√©cup√©rer le dossier : ${err.message}</p>`;
        detailRefTitle.textContent = "Erreur";
        return;
    }

    // --- Gestion des √âv√©nements des Boutons (Non modifi√©e, mais incluse pour √™tre complet) ---
    
    document.getElementById('btn-retour-liste').addEventListener('click', () => {
        window.location.href = 'liste_dossiers.html';
    });
    
    document.getElementById('btn-valider-dossier').addEventListener('click', async () => {
        if (!dossier || !dossier.dossier_id) {
            alert("‚ö†Ô∏è Dossier introuvable, impossible de continuer la validation.");
            return;
        }
        
        const confirmation = confirm("√ätes-vous s√ªr de vouloir VALIDER ce dossier ? Cette action est g√©n√©ralement irr√©versible.");
        if (!confirmation) return;
    
        try {
            const res = await fetch(`https://moto-api-cika.onrender.com/api/dossiers/${dossier.dossier_id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ valide: true }) 
            });
    
            const resBody = await res.json();
            
            if (!res.ok) throw new Error(resBody.message || `Erreur ${res.status}`);
            
            alert(`‚úÖ Dossier ${dossier.reference_dossier} VALID√â avec succ√®s.`);
            
            window.location.href = `carte_grise_AVANT_FIN____.html?ref=${encodeURIComponent(dossier.reference_dossier)}`;
    
        } catch (err) {
            console.error("Erreur de validation:", err);
            alert(`‚ùå √âchec de validation : ${err.message}`);
        }
    });

    document.getElementById('btn-rejeter-dossier').addEventListener('click', async () => {
        if (!dossier || !dossier.dossier_id) {
            alert("‚ö†Ô∏è Dossier introuvable, impossible de rejeter.");
            return;
        }

        const motif = prompt(`‚ö†Ô∏è MOTIF DE REJET OBLIGATOIRE :`);
        if (!motif) {
            alert("Le motif de rejet est obligatoire.");
            return;
        }
        
        try {
            const res = await fetch(`https://moto-api-cika.onrender.com/api/dossiers/${dossier.dossier_id}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ statut: 'rejet√©', motif_rejet: motif }) 
            });

            const resBody = await res.json();
            
            if (!res.ok) throw new Error(resBody.message || `Erreur ${res.status}`);
            
            alert(`‚ùå DOSSIER REJET√â : Motif : ${motif}`);
            
            window.location.href = 'liste_dossiers.html';
        } catch (err) {
            console.error("Erreur de rejet:", err);
            alert(`‚ùå √âchec de rejet : ${err.message}`);
        }
    });
});
</script>

</body>
</html>
